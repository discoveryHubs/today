# FILE: .github/workflows/build.yml
name: Build Discovery Hub (Multi-Cloud)

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
  workflow_dispatch:
    inputs:
      urls:
        description: "Paste URLs (one per line)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: discovery-hub-build
  cancel-in-progress: true

jobs:
  build:
    if: ${{ github.event_name == 'workflow_dispatch' || github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prep dist
        run: |
          rm -rf dist
          mkdir -p dist/netlify dist/vercel

      - name: Build (GitHub Pages)
        env:
          DOCS_DIR: docs
          SITE_VARIANT: github-pages
          SITE_NAME: Discovery Hub
          REPO_URL: https://github.com/${{ github.repository }}
          BUILD_NONCE: ${{ github.run_id }}
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          EXTRA_URLS: ${{ github.event.inputs.urls }}
          ENABLE_INDEXNOW: "1"
          ENABLE_PINGOMATIC: "1"
          ENABLE_AI: "1"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.5-flash
          MAX_AI_CALLS: "30"
        run: |
          python scripts/build.py

      - name: Build (Netlify)
        env:
          DOCS_DIR: dist/netlify
          SITE_VARIANT: netlify
          SITE_NAME: Discovery Hub
          REPO_URL: https://github.com/${{ github.repository }}
          BUILD_NONCE: ${{ github.run_id }}
          BASE_URL: https://dailyhubs.netlify.app
          EXTRA_URLS: ""
          ENABLE_INDEXNOW: "1"
          ENABLE_PINGOMATIC: "1"
          ENABLE_AI: "0"
        run: |
          python scripts/build.py
          python scripts/netlify_fix.py dist/netlify https://dailyhubs.netlify.app

      - name: Build (Vercel)
        env:
          DOCS_DIR: dist/vercel
          SITE_VARIANT: vercel
          SITE_NAME: Discovery Hub
          REPO_URL: https://github.com/${{ github.repository }}
          BUILD_NONCE: ${{ github.run_id }}
          BASE_URL: https://daily-hub-livid.vercel.app
          EXTRA_URLS: ""
          ENABLE_INDEXNOW: "1"
          ENABLE_PINGOMATIC: "1"
          ENABLE_AI: "0"
        run: |
          python scripts/build.py

      - name: Commit docs + data (GitHub Pages)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs data
            git commit -m "Update Discovery Hub"
            git push
          else
            echo "No changes."
          fi

      - name: Check deploy keys
        id: deploycheck
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [[ -n "$NETLIFY_AUTH_TOKEN" && -n "$NETLIFY_SITE_ID" ]]; then
            echo "netlify=true" >> "$GITHUB_OUTPUT"
          else
            echo "netlify=false" >> "$GITHUB_OUTPUT"
          fi

          if [[ -n "$VERCEL_TOKEN" && -n "$VERCEL_ORG_ID" && -n "$VERCEL_PROJECT_ID" ]]; then
            echo "vercel=true" >> "$GITHUB_OUTPUT"
          else
            echo "vercel=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to Netlify
        if: ${{ steps.deploycheck.outputs.netlify == 'true' }}
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: dist/netlify
          production-branch: main
          production-deploy: true
          deploy-message: "Discovery Hub deploy (Netlify)"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy to Vercel
        if: ${{ steps.deploycheck.outputs.vercel == 'true' }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: dist/vercel
          vercel-args: "--prod"
          github-comment: false
